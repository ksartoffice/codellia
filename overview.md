Codellia Editor – Live HTML/CSS/JS Editor with Tailwind CSS
===============================================

概要
----
- プラグイン正式名は「Codellia Editor」。内部名/各種識別子は「Codellia」。
- Codellia専用のカスタム投稿タイプ `codellia` を登録し、通常の投稿/固定ページは対象外。
- 新規作成時は専用エディタ (`admin.php?page=codellia`) へ自動遷移。既存投稿ではブロック/クラシックに「Edit with Codellia」ボタンを追加して遷移。
- Monaco Editor で HTML/CSS/JavaScript を編集し、右側 iframe に実フロントを即時プレビュー。
- 管理一覧には TailwindCSS 使用状態を表示。

編集UI (React)
-------------
- ツールバー: Back、Undo/Redo、タイトル編集、ステータス変更（下書き/レビュー/非公開/公開）、ビューポート切替（Desktop/Tablet/Mobile）、エディタ表示切替、Save、Export、Settings、プレビュー/表示リンク。未保存の変更を表示し、離脱時に警告。
- エディタ: HTML と CSS/JS タブ、JS は Run ボタンでプレビューへ即時実行。
- ペインは左右/上下リサイズ、設定パネルは「Settings」「Elements」タブで開閉。
- Settings タブ: 出力/レンダリング/外部リソース/表示の各設定を管理。
- 要素タブ: 選択した要素のテキスト/属性を編集（安全なテキストノードのみ）。

プレビューと DOM セレクタ
--------------------------
- `?codellia_preview=1&post_id=...&token=...` で実フロントを表示し、`<!--codellia:start-->...<!--codellia:end-->` 内を差し替え。
- parse5 で `data-codellia-id` を付与し、ホバー/クリックで該当要素をハイライト。
- 選択時に要素タブを開くアクションボタンを表示し、エディタ/設定と選択状態を同期。

セットアップ/インポート
----------------------
- 初回はセットアップウィザードで「Normal」/「Tailwind」/「Import JSON」を選択し、`_codellia_tailwind_locked` で固定。
- Import/Export JSON v1: HTML/CSS/JS、Tailwind、生成CSS、外部スクリプト/スタイル、Shadow DOM/Shortcode/単一ページ公開/Live Highlight。
- Import時はHTMLをそのまま反映（外部画像の取り込みは行わない）。

Tailwind CSS
------------
- Tailwind モードでは TailwindPHP で CSS を自動コンパイル。
- 生成CSSは `_codellia_generated_css`、ユーザーCSSは `_codellia_css` に保存。
- プレビューは `CODELLIA_SET_CSS` で CSS だけ差し替え可能。

外部アセット (Script / Style)
------------------------------
- 外部スクリプト: https:// のみ、最大 5 件。JS 有効時のみ読み込み。
- 外部スタイル: https:// のみ、最大 5 件。プレビュー/フロントに `<link>` で読み込み。

Shadow DOM
----------
- 有効化時は `<template shadowrootmode="open">` で隔離し、CSS/JS/外部スタイルを Shadow root 内に適用。

ショートコード
--------------
- ショートコードは設定で有効化した場合のみ出力。`[codellia post_id="123"]` で埋め込み可能。公開状態/権限をチェックし、Shadow DOM 設定も尊重。
- ショートコード有効時は「単一ページとして公開しない」を切り替え可能。

フロント表示
------------
- Codellia 投稿の本文を出力し、CSS/JS/外部アセットをインラインまたは enqueue。
- Shadow DOM 有効時はホスト要素にテンプレートを差し込み。
- `wpautop`/`shortcode_unautop` を外し、不要な `<p>` 挿入を防止。
- 単一ページ公開を無効化した場合は noindex を付与し、検索/アーカイブから除外。単一ページはリダイレクトまたは 404（`codellia_single_page_redirect` フィルタ）で制御。

REST API
--------
- `/codellia/v1/save`: HTML/CSS/JS の保存、Tailwind コンパイル。
- `/codellia/v1/compile-tailwind`: プレビュー用コンパイル。
- `/codellia/v1/setup`: セットアップモード決定。
- `/codellia/v1/import`: JSON インポート。
- `/codellia/v1/settings`: 各種設定の更新。
- `/codellia/v1/render-shortcodes`: ショートコードのサーバレンダリング。

保存データ (post_meta)
----------------------
- `_codellia_css`, `_codellia_js`
- `_codellia_tailwind`, `_codellia_tailwind_locked`, `_codellia_generated_css`
- `_codellia_shadow_dom`, `_codellia_shortcode_enabled`, `_codellia_single_page_enabled`
- `_codellia_external_scripts`, `_codellia_external_styles`
- `_codellia_live_highlight`, `_codellia_setup_required`

管理設定
--------
- `Codellia > Settings` で投稿スラッグ (`codellia_post_slug`) を変更可能。
- 同画面でアンインストール時のデータ削除を設定（`codellia_delete_on_uninstall`）。

postMessage プロトコル
----------------------
- 親 -> iframe: `CODELLIA_INIT`, `CODELLIA_RENDER`, `CODELLIA_SET_CSS`, `CODELLIA_RUN_JS`, `CODELLIA_DISABLE_JS`,
  `CODELLIA_EXTERNAL_SCRIPTS`, `CODELLIA_EXTERNAL_STYLES`, `CODELLIA_SET_HIGHLIGHT`, `CODELLIA_SET_ELEMENTS_TAB_OPEN`
- iframe -> 親: `CODELLIA_READY`, `CODELLIA_SELECT`, `CODELLIA_OPEN_ELEMENTS_TAB`

権限/セキュリティ
-----------------
- Codellia 投稿かつ `edit_post` を満たす場合のみ編集可能。
- JS/外部スクリプト/外部スタイル/Shadow DOM/ショートコード/単一ページ公開の更新は `unfiltered_html` が必要。
- プレビューは nonce 付き token と `event.origin` を検証。



