(function(){"use strict";function o(e,a){const t=document.createElement(e);return a&&(t.className=a),t}async function v(e){const a=window.require||window.requirejs;if(!a)throw new Error("Monaco AMD loader (window.require) not found.");return a.config({paths:{vs:e}}),await new Promise((t,s)=>{a(["vs/editor/editor.main"],()=>{if(!window.monaco)return s(new Error("window.monaco is missing after load."));t(window.monaco)})})}function g(e,a){let t;return(...s)=>{window.clearTimeout(t),t=window.setTimeout(()=>e(...s),a)}}function C(e){const a=o("div","lc-app"),t=o("div","lc-toolbar"),s=o("button","button lc-btn");s.textContent="Undo";const r=o("button","button lc-btn");r.textContent="Redo";const i=o("button","button button-primary lc-btn");i.textContent="保存";const c=o("span","lc-status");c.textContent="",t.append(s,r,i,c);const d=o("div","lc-main"),u=o("div","lc-left"),l=o("div","lc-right"),m=o("div","lc-tabs"),n=o("button","lc-tab is-active");n.textContent="HTML",n.dataset.tab="html";const p=o("button","lc-tab");p.textContent="CSS",p.dataset.tab="css",m.append(n,p);const b=o("div","lc-editorWrap"),f=o("div","lc-editor");b.append(f),u.append(m,b);const w=document.createElement("iframe");return w.className="lc-iframe",w.referrerPolicy="no-referrer-when-downgrade",l.append(w),d.append(u,l),a.append(t,d),e.append(a),{btnUndo:s,btnRedo:r,btnSave:i,status:c,tabHtml:n,tabCss:p,editorDiv:f,iframe:w}}async function h(){const e=window.WP_LIVECODE,a=document.getElementById("wp-livecode-app");if(!a)return;const t=C(a);wp?.apiFetch?.createNonceMiddleware&&wp.apiFetch.use(wp.apiFetch.createNonceMiddleware(e.restNonce)),t.iframe.src=e.previewUrl;const s=new URL(e.previewUrl).origin;t.status.textContent="Loading Monaco...";const r=await v(e.monacoVsPath),i=r.editor.createModel(e.initialHtml??"","html"),c=r.editor.createModel(e.initialCss??"","css"),d=r.editor.create(t.editorDiv,{model:i,theme:"vs-dark",automaticLayout:!0,minimap:{enabled:!1},fontSize:13});t.status.textContent="";function u(n){t.tabHtml.classList.toggle("is-active",n==="html"),t.tabCss.classList.toggle("is-active",n==="css"),d.setModel(n==="html"?i:c),d.focus()}t.tabHtml.addEventListener("click",()=>u("html")),t.tabCss.addEventListener("click",()=>u("css"));const l=()=>{const n={type:"LC_RENDER",html:i.getValue(),css:c.getValue()};t.iframe.contentWindow?.postMessage(n,s)},m=g(l,120);i.onDidChangeContent(m),c.onDidChangeContent(m),t.iframe.addEventListener("load",()=>{l()}),t.btnUndo.addEventListener("click",()=>d.trigger("toolbar","undo",null)),t.btnRedo.addEventListener("click",()=>d.trigger("toolbar","redo",null)),t.btnSave.addEventListener("click",async()=>{t.status.textContent="Saving...";try{(await wp.apiFetch({url:e.restUrl,method:"POST",data:{postId:e.postId,html:i.getValue(),css:c.getValue()}}))?.ok?(t.status.textContent="Saved.",window.setTimeout(()=>t.status.textContent="",1200)):t.status.textContent="Save failed."}catch(n){t.status.textContent=`Save error: ${n?.message??n}`}}),window.addEventListener("message",n=>{if(n.origin!==s)return;n.data?.type==="LC_READY"&&l()})}h().catch(e=>{console.error(e)})})();
//# sourceMappingURL=main.js.map
